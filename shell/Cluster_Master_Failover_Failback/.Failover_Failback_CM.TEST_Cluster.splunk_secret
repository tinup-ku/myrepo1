
Splunk Articles:
https://docs.splunk.com/Documentation/Splunk/8.2.1/Indexer/Managersitefailure
https://docs.splunk.com/Documentation/Splunk/8.2.1/Indexer/Handlemanagernodefailure
https://docs.splunk.com/Documentation/Splunk/8.2.1/Indexer/Restartindexing

TEST Index and Search Head cluster:

. TEST Indexers $CLUSTER
  PDC1: PDC1_TEST_Indexers
  PDC3: PDC3_TEST_Indexers
  LUMP: All_TEST_Indexers
  Cluster Masters:
    - Primary: svm3279pdv
    - Backup:  svm3279bdv

. TEST SH cluster and standalone

  - SH Cluster:
    GROUP:PDC1_TEST_Search_SH
    svm3285pdv
    svm3286pdv
    svm3291pdv
    svm3292pdv
    GROUP:PDC3_TEST_Search_SH
    svm3283bdv
    svm3284bdv
    LUMP:All_TEST_Search_SH
    PDC1_TEST_Search_SH
    PDC3_TEST_Search_SH  

  - Standalone: svm3282pdv,svm3282bdv

PREPARATION STEPS:
  1. Currently all Indexers and search heads are pointing to 
     https://splunktestmaster.dev.schwab.com:8089, or
     https://svm3279pdv.dev.schwab.com:8089

     - Create/Stage ${SPLUNK_LOCAL}/server.conf.FAILOVER on all Indexers and SHs pointing
       to Backup Cluster Master, svm3279bdv 

       On DEV Control server,cud2-008140, as root

       [root@cud2-008140 ~]#  jldsh -eg All_TEST_Indexers,All_TEST_Search_SH -ew svm3282pdv,svm3282bdv "cd /opt/splunk/etc/system/local;sed -e 's/splunktestmaster.dev.schwab.com/svm3279bdv.dev.schwab.com/g' -e 's/svm3279pdv.dev.schwab.com/svm3279bdv.dev.schwab.com/g' server.conf > server.conf.FAILOVER"

       Verify:

----- cut here -----

     [root@cud2-008140 ~]# !!|dshbak
     jldsh -eg All_TEST_Indexers,All_TEST_Search_SH -ew svm3282pdv,svm3282bdv "cd /opt/splunk/etc/system/local;diff server.conf server.conf.FAILOVER"|dshbak
---------------
Node svm3287pdv
---------------
30c30
< master_uri = https //splunktestmaster.dev.schwab.com 8089
---
> master_uri = https //svm3279bdv.dev.schwab.com 8089

---------------
Node svm3282bdv
---------------
31c31
< master_uri = https //svm3279pdv.dev.schwab.com 8089
---
> master_uri = https //svm3279bdv.dev.schwab.com 8089

----- cut here -----

 2. On All current Indexers and Search Heads, make a backup ${SPLUNK_LOCAL}/server.conf:
    ${SPLUNK_LOCAL}/server.conf --> ${SPLUNK_LOCAL}/server.conf.PRIMARY

    [root@cud2-008140 ~]# jldsh -eg All_TEST_Indexers,All_TEST_Search_SH -ew svm3282pdv,svm3282bdv "cd /opt/splunk/etc/system/local;cp -f server.conf server.conf.PRIMARY"

 3. On Backup CM, svm3279bdv:/opt/splunk/etc/system/local, 
    3.1 make a backup
    cd /opt/splunk/etc/system/local && cp -f server.conf server.conf.BCK 

 4. On both Cluster Masters, set up trust relationship between 
    - Primary PDC1_TEST_Index_Cluster_Master: svm3279pdv and
    - Backup PDC3_TEST_Index_Cluster_Master: svm3279bdv
   
    4.1. On Primary cluster master, svm3282pdv, Setup rsync via cron to backup CM
         - svm3282pdv:${SPLUNK_HOME}/etc/master-apps and
         - svm3282pdv:${SPLUNK_HOME}/var/run/splunk/cluster/remote-bundle/ directory

         svm3279pdv's cron job:

         0 12,15,18,21 * * * rsync -arv --delete ${SPLUNK_HOME}/etc/master-apps svm3279bdv:${SPLUNK_HOME}/etc/ 2>/dev/null
         0 12,15,18,21 * * * rsync -arv --delete ${SPLUNK_HOME}/var/run/splunk/cluster/remote-bundle svm3279bdv:${SPLUNK_HOME}/var/run/splunk/cluster/ 2>/dev/null

3. On Backup cluster master, svm3279bdv, $SPLUNK_HOME/etc/system/local, follow steps
   from the link below. 

   https://docs.splunk.com/Documentation/Splunk/8.2.1/Indexer/Handlemanagernodefailure
Note:
- For the backup CM, svm3279bdv, manually install splunk.
  As root,
  mount nas30u0dev.dev.schwab.com:/infra/softdepot /mnt
  cd /mnt/Splunk/8.1.1
  rpm -ivh splunk-8.1.1-08187535c166-linux-2.6-x86_64.rpm

  ****** IMPORTANT ******
  1. Before starting Splunk, copied svm3279bdv:/opt/splunk/etc/auth/splunk.secret
     to svm3279bdv:/opt/splunk/etc/auth/splunk.secret

  2. Start splunk,
     ${SPLUNK_BIN}/splunk enable boot-start --answer-yes --no-prompt --accept-license





   PREPARATION:
   - Back up files that the replacement manager (backup CM svm3279bdc) needs:
     . $SPLUNK_HOME/etc/system/local/
       server.conf
       web.conf
     . $SPLUNK_HOME/etc/master-apps directory
     . $SPLUNK_HOME/var/run/splunk/cluster/remote-bundle/ directory

   3.1 Make a backup copy of server.conf --> server.conf_Backup_Master
   3.2 On backup CM svm3279bdv, stage server.conf.FAILOVER, which has Primary Cluster Master svm3279pdv's server.conf:

----- BEGIN cut here from Primary svm3279pdv server.conf -----
[sslConfig]
sslPassword = $1$+6DorXzH7ysT

[clustering]
mode = master
replication_factor = 1
search_factor = 1
multisite = true
available_sites = site1,site2
site_replication_factor = origin:1,total:2
site_search_factor = origin:1,total:2
pass4SymmKey = testcluster
cluster_label = testcluster

[kvstore]
disabled = true


[license]
master_uri = https://svm3280pdv:8089

----- END cut here -----

Next, on svm3279bdv:/opt/splunk/etc/system/local/server.conf.FAILOVER, append
the above.

The result,

----- BEGIN server.conf.FAILOVER -----
[general]
serverName = svm3279bdv
pass4SymmKey = $1$TtRnymj/NgHi

[sslConfig]
sslPassword = $1$GZgzli25fVPi --> This comes from svm3279pdv server.conf.ORIG 
                                  (step 5)
[lmpool:auto_generated_pool_download-trial]
description = auto_generated_pool_download-trial
quota = MAX
slaves = *
stack_id = download-trial

[lmpool:auto_generated_pool_forwarder]
description = auto_generated_pool_forwarder
quota = MAX
slaves = *
stack_id = forwarder

[lmpool:auto_generated_pool_free]
description = auto_generated_pool_free
quota = MAX
slaves = *
stack_id = free

[license]
master_uri = https://svm3280pdv:8089

[clustering]
mode = master
replication_factor = 1
search_factor = 1
multisite = true
available_sites = site1,site2
site_replication_factor = origin:1,total:2
site_search_factor = origin:1,total:2
pass4SymmKey = testcluster  --> step 6
cluster_label = testcluster

[kvstore]
disabled = true

----- END server.conf.FAILOVER -----


   3.3 Start splunk, via start_splunk
   3.4 Run, as svc.eli_admin.dev, `${SPLUNK_BIN}/splunk set indexing-ready -auth admin;${key}`

   Ref: https://docs.splunk.com/Documentation/Splunk/7.2.6/Indexer/Restartindexing


4. On All Indexers, point current Master Cluster svm4028pdv to svm4028bdv
   Refer to https://docs.splunk.com/Documentation/Splunk/7.2.6/Indexer/Restartindexing

5. On All SHs, point current Master Cluster svm4028pdv to svm4028bdv
