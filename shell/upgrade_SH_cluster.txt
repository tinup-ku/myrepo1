I. all_Search_heads
--------------------------
1. Backup search head kvstore
multi_ssh_Search_heads "su - svc.eli_admin.prod -c 'backup_kvstore 2>/dev/null'"|dshbak

2. INTENTIONALLY LEFT BLANK

3. Stop Splunkd
   multi_ssh_Search_heads "systemctl stop Splunkd"

   Verify:
   multi_ssh_Search_heads "pgrep splunkd|wc -l"
   multi_ssh_Search_heads "show_splunk|grep SPLUNK"

4. Upgrade splunk to 9.1.3

   multi_ssh_Search_heads "upgrade_splunk -v 9.1.3"

   NOTE:
   On a putty session, check upgrade status via

   watch -n5 'multi_ssh_Search_heads "tail -1 upgrade_splunk.\`date '+%Y%m%d'\`.OUT"'

   Verify:
   multi_ssh_Search_heads "rpm -q splunk"

5. Start Splunk

   multi_ssh_Search_heads "start_splunk"

   Verify:
   multi_ssh_Search_heads "pgrep splunkd|wc -l"
   multi_ssh_Search_heads "show_splunk|grep SPLUNK"

6. Verify SH Cluster's captain and kvstore
   Wait at least 2mins for SHC to elect its captain...

   multi_ssh_Search_heads "show_captain"
   multi_ssh_Search_heads "show_kvstore"
   multi_ssh_Search_heads "show_shcluster-status|egrep 'label|status'"|dshbak

-----------------
II. SHC Deployers
-----------------

   multi_ssh_Deployer "systemctl stop Splunkd"

   Verify:
   multi_ssh_Deployer "pgrep splunkd|wc -l"
   multi_ssh_Deployer "show_splunk|grep SPLUNK"

   multi_ssh_Deployer "upgrade_splunk -v 9.1.3"

   Verify:
   multi_ssh_Deployer "rpm -q splunk"

   multi_ssh_Deployer "start_splunk"

   Verify:
   multi_ssh_Deployer "pgrep splunkd|wc -l"
   multi_ssh_Deployer "show_splunk|grep SPLUNK"

8. Validate all_Search_heads via url or from restAPI call.

   8.1 Validate via restAPI call
       cd /root/scripts && ./search_via_restAPI.Adhoc_Scheduled

9. Login to SHC Deployer
   `push_bundle`

------------------
III. Standalone_SH
------------------

1. Stop Splunkd
   multi_ssh_standalone_Search_heads "systemctl stop Splunkd"

   Verify:
   multi_ssh_standalone_Search_heads "pgrep splunkd|wc -l"
   multi_ssh_standalone_Search_heads "show_splunk|grep SPLUNK"

2. Upgrade Splunk
   multi_ssh_standalone_Search_heads "upgrade_splunk -v 9.1.3"

   Verify:
   multi_ssh_standalone_Search_heads "rpm -q splunk"

3. Start Splunk
   multi_ssh_standalone_Search_heads "start_splunk"

   Verify:
   multi_ssh_standalone_Search_heads "pgrep splunkd|wc -l"
   multi_ssh_standalone_Search_heads "show_splunk|grep SPLUNK"

4. Validation
       cd /root/scripts && ./search_via_restAPI.Adhoc_Scheduled


###############
BACKOUT STEPS:
###############
1. Stop Splunkd
   multi_ssh_Search_heads "systemctl stop Splunkd"

   Verify:
   multi_ssh_Search_heads "pgrep splunkd|wc -l"

2. Backout splunk to 9.0.7

   multi_ssh_Search_heads "backout_splunk -v 9.0.7"

   Verify:
   multi_ssh_Search_heads "rpm -q splunk"

3. Start Splunk

   multi_ssh_Search_heads "start_splunk"

   Verify:
   multi_ssh_Search_heads "pgrep splunkd|wc -l"

4. Verify SH Cluster's captaincy and kvstore
   Wait at least 2mins for SHC to elect its captain...

   multi_ssh_Search_heads "show_captain"
   multi_ssh_Search_heads "show_kvstore"
   multi_ssh_Search_heads "show_kvstore-status"
   multi_ssh_Search_heads "show_shcluster-status|egrep 'label|status'"|dshbak

5. Backout loc_Deployer


   multi_ssh_Deployer "systemctl stop Splunkd"

   Verify:
   multi_ssh_Deployer "pgrep splunkd|wc -l"

   multi_ssh_Deployerr "backout_splunk -v 9.0.7"

   Verify:
   multi_ssh_Deployer "rpm -q splunk"

   multi_ssh_Deployerr "start_splunk"

   Verify:
   multi_ssh_Deployer "pgrep splunkd|wc -l"

8. Validate all_Search_heads via url or from restAPI call.

   8.1 Validate via restAPI call
       cd /root/scripts && ./search_via_restAPI.PROD


9. Login to SHC Deployer
   `push_bundle`

